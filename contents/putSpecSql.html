<div class="sql-tool-container p-4 sm:p-6 bg-white rounded-lg shadow mb-6">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">SQL 參數替換工具</h1>

    <label for="sqlInput" class="block text-gray-700 font-medium mb-1">輸入 SQL：</label>
    <textarea id="sqlInput" class="w-full mb-4 font-mono p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-40 resize-y"></textarea>

    <button id="extractParamsBtn" class="w-full mb-4 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">掃描參數</button>

    <h2 class="text-xl font-semibold mb-3 text-gray-800">參數輸入：</h2>
    <div id="paramsContainer" class="mt-2 p-4 bg-gray-50 border border-gray-200 rounded-md">
        <p class="text-gray-500">點擊「掃描參數」後，這裡會出現參數輸入框。</p>
    </div>

    <button id="replaceParamsBtn" class="w-full mt-6 mb-6 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">執行替換</button>

    <h2 class="text-xl font-semibold mb-3 mt-6 text-gray-800">最終 SQL：</h2>
    <div id="output-container" class="mt-2 p-4 bg-gray-50 border border-gray-200 rounded-md relative">
        <pre id="output" class="whitespace-pre-wrap font-mono text-gray-800 mb-4"></pre>
        <button id="copyBtn" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">複製</button>
    </div>
</div>

<script>
    // JavaScript logic for the SQL tool
    function extractParams() {
      const sqlInput = document.getElementById("sqlInput");
      if (!sqlInput) { console.error("Element #sqlInput not found"); return; }
      const sql = sqlInput.value;

      const paramPattern = /'Parm\d+'/g;
      const matches = sql.match(paramPattern);
      const uniqueMatches = matches ? [...new Set(matches)] : [];

      const paramsContainer = document.getElementById("paramsContainer");
      if (!paramsContainer) { console.error("Element #paramsContainer not found"); return; }
      paramsContainer.innerHTML = "";

      if (uniqueMatches.length === 0) {
        paramsContainer.innerHTML = "<p class='text-gray-600'>未找到任何 'ParmX' 參數。</p>";
        return;
      }

      uniqueMatches.forEach(param => {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "param-input block my-2 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400";
        input.placeholder = `替換 ${param}`;
        input.dataset.param = param;
        paramsContainer.appendChild(input);
      });
    }

    function replaceParams() {
      const sqlInput = document.getElementById("sqlInput");
      const outputElement = document.getElementById("output");
      if (!sqlInput || !outputElement) { console.error("Required elements for replaceParams not found"); return; }

      let sql = sqlInput.value;
      const inputs = document.querySelectorAll("#paramsContainer .param-input");

      inputs.forEach(input => {
        const param = input.dataset.param;
        const replacement = input.value;
        const regex = new RegExp(param.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
        sql = sql.replace(regex, `'${replacement.replace(/'/g, "''")}'`);
      });

      outputElement.innerText = sql;
    }

    function copySQL() {
      const outputElement = document.getElementById("output");
      if (!outputElement) {
          alert("找不到輸出內容！");
          return;
      }
      const outputText = outputElement.innerText;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(outputText).then(() => {
          alert("SQL 已複製到剪貼簿！");
        }).catch(err => {
          console.error('複製失敗:', err);
          alert("複製失敗，請手動複製。錯誤：" + err);
        });
      } else {
          // Fallback for browsers that don't support navigator.clipboard
          const range = document.createRange();
          range.selectNodeContents(outputElement);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          try {
              document.execCommand('copy');
              alert("SQL 已複製到剪貼簿！ (備用方案)");
          } catch (err) {
              console.error('備用複製方案失敗:', err);
              alert("複製失敗，請手動複製。");
          }
          selection.removeAllRanges(); // 清除選取
      }
    }

    // 使用 addEventListener 綁定事件
    function initializeSqlTool() {
        console.log("SQL Tool initialized. Attaching event listeners.");
        const extractBtn = document.getElementById('extractParamsBtn');
        const replaceBtn = document.getElementById('replaceParamsBtn');
        const copyBtn = document.getElementById('copyBtn');

        if (extractBtn) extractBtn.addEventListener('click', extractParams);
        if (replaceBtn) replaceBtn.addEventListener('click', replaceParams);
        if (copyBtn) copyBtn.addEventListener('click', copySQL);

        // 如果需要在載入時就掃描 SQL Input 的內容（例如從 hash 中讀取）
        // 可以在這裡呼叫 extractParams();
    }

    // 當這個腳本被執行時，呼叫初始化函式
    // 使用 DOMContentLoaded 確保 DOM 元素在腳本嘗試綁定事件時已經存在
    document.addEventListener('DOMContentLoaded', initializeSqlTool);

</script>

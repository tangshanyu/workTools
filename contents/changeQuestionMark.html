<div class="sql-question-mark-tool-container p-4 sm:p-6 bg-white rounded-lg shadow mb-6">
  <h1 class="text-2xl font-semibold mb-4 text-gray-800">SQL 問號轉換工具</h1>

  <label for="sqlInput" class="block text-gray-700 font-medium mb-1">原始 SQL（含 ?）：</label>
  <textarea id="sqlInput" class="w-full mb-4 font-mono p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-40 resize-y"></textarea>

  <label for="paramsInput" class="block text-gray-700 font-medium mb-1">參數（格式：[15761, 02, BCTOM0001, 2024/06/04]）：</label>
  <textarea id="paramsInput" class="w-full mb-4 font-mono p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-24 resize-y"></textarea>

  <button onclick="replaceSQL()" class="w-full mb-4 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">轉換</button>

  <h2 class="text-xl font-semibold mb-3 text-gray-800">轉換後的 SQL：</h2>
  <div id="output-container" class="mt-2 p-4 bg-gray-50 border border-gray-200 rounded-md relative">
        <pre id="output" class="whitespace-pre-wrap font-mono text-gray-800 mb-4"></pre>
    <button id="copyBtn" onclick="copySQL()" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">複製</button>
  </div>

  <script>
    function escapeString(str) {
      if (str === null || str === undefined) {
        return ''; // 或根據需要處理 null/undefined
      }
      return String(str).replace(/'/g, "''"); // 確保是字串再處理
    }

    function smartParseParams(text) {
      text = text.trim();
      // 處理方括號，但更彈性，允許沒有方括號
      if (text.startsWith('[') && text.endsWith(']')) {
        text = text.substring(1, text.length - 1);
      }

      // 使用 JSON.parse 嘗試解析，可以處理更多資料類型，更穩健
      try {
        // 將字串轉換為有效的 JSON 陣列字串
        const jsonString = `[${text}]`;
        const parsedArray = JSON.parse(jsonString);

        // 將解析出來的每個元素轉換為 SQL 字符串格式（加單引號並轉義）
        return parsedArray.map(item => {
          // 處理 null 值
          if (item === null) {
            return 'NULL'; // SQL 中的 NULL
          }
          // 對字符串進行轉義並加上單引號
          return `'${escapeString(item)}'`;
        });

      } catch (e) {
        console.error("參數解析失敗:", e);
        // 如果 JSON.parse 失敗，嘗試回退到簡單的 split 方法
        console.warn("嘗試使用簡單的逗號分隔解析...");
        try {
          const items = text.split(/\s*,\s*/);
          return items.map(item => `'${escapeString(item.trim())}'`);
        } catch (splitErr) {
          console.error("簡單分隔解析也失敗:", splitErr);
          throw new Error("參數格式錯誤，請檢查輸入格式。"); // 拋出更明確的錯誤
        }
      }
    }


    function replaceSQL() {
      const sqlInput = document.getElementById("sqlInput");
      const paramsInput = document.getElementById("paramsInput");
      const outputElement = document.getElementById("output");

      if (!sqlInput || !paramsInput || !outputElement) {
          console.error("找不到必要的輸入或輸出元素");
          alert("網頁元素載入錯誤，請刷新頁面。");
          return;
      }


      const sql = sqlInput.value;
      const rawParams = paramsInput.value;

      let params;
      try {
        params = smartParseParams(rawParams);
      } catch (e) {
        alert(e.message); // 顯示 smartParseParams 拋出的錯誤訊息
        outputElement.innerText = ""; // 清空輸出
        return;
      }

      let result = '';
      let paramIndex = 0;
      let sqlIndex = 0;

      while(sqlIndex < sql.length) {
        if (sql[sqlIndex] === '?') {
          if (paramIndex < params.length) {
            result += params[paramIndex++];
            sqlIndex++; // 跳過 '?'
          } else {
            // 如果參數用完了，保留剩餘的問號
            result += '?';
            sqlIndex++;
            alert("⚠️ SQL 中的問號比提供的參數多！");
          }
        } else {
          result += sql[sqlIndex];
          sqlIndex++;
        }
      }


      if (paramIndex < params.length) {
        alert("⚠️ 有多餘的參數未被使用！");
      }

      outputElement.innerText = result;
    }

    function copySQL() {
      const outputElement = document.getElementById("output");
      if (!outputElement) {
          alert("找不到輸出內容！");
          return;
      }
      const outputText = outputElement.innerText;

      navigator.clipboard.writeText(outputText).then(() => {
        alert("SQL 已複製到剪貼簿！");
      }).catch(err => {
        console.error('複製失敗:', err);
        alert("複製失敗，請手動複製。錯誤：" + err);
      });
    }

    // 頁面內容載入後，執行初始化邏輯 (如果需要的話)
    function initializeQuestionMarkTool() {
        console.log("SQL Question Mark Tool initialized.");
        // 如果需要在載入時做任何事情，可以在這裡添加
    }

    // 當這個腳本被執行時，呼叫初始化函式
    initializeQuestionMarkTool();

  </script>
